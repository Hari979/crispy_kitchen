name: Deploy to EC2 on Tag Push

on:
  push:
    tags:
      - '*'  # Runs on all new tags

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy on EC2 via SSH
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          REPO_PAT: ${{ secrets.REPO_PAT }}
          TAG: ${{ github.ref_name }}
        run: |
          echo '
          set -e

          BASE_PATH="/var/www/admin/httpdocs"
          LIVE_DIR="$BASE_PATH/SFI-Admin-UI"
          DATE=$(date +%F)
          COUNT=1

          while [ -d "$BASE_PATH/SFI-Admin-UI-$DATE-$COUNT" ]; do
            COUNT=$((COUNT + 1))
          done

          BACKUP_DIR="$BASE_PATH/SFI-Admin-UI-$DATE-$COUNT"
          echo "Backing up $LIVE_DIR to $BACKUP_DIR"
          sudo mv "$LIVE_DIR" "$BACKUP_DIR"

          echo "Downloading release ZIP for tag: $TAG"
          TMP_DIR=$(mktemp -d)
          curl -L -H "Authorization: token $REPO_PAT" \
            -o "$TMP_DIR/release.zip" \
            "https://github.com/Hari979/crispy_kitchen/archive/refs/tags/$TAG.zip"

          unzip "$TMP_DIR/release.zip" -d "$TMP_DIR"
          EXTRACTED_FOLDER=$(find "$TMP_DIR" -maxdepth 1 -type d -name "crispy_kitchen-*")

          echo "Deploying to $LIVE_DIR"
          sudo mkdir -p "$LIVE_DIR"
          sudo rsync -av "$EXTRACTED_FOLDER"/ "$LIVE_DIR"/

          rm -rf "$TMP_DIR"

          echo "Restarting Apache..."
          sudo systemctl restart apache2

          echo "Deployment complete for tag $TAG"
          ' | ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST 'REPO_PAT='"$REPO_PAT"' TAG='"$TAG"' bash -s'
